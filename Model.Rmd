---
title: "Model"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---


```{r message = FALSE, warning = FALSE, include=FALSE}
library(tidyverse)
library(ggplot2)
library(patchwork)
library(broom)
parkevent = read.csv("parkevent_clean.csv")
library(MASS)
library(modelr)
```


## Modeling Workflow Diagram

                         ┌──────────────────────────────────┐
                         │  Exploratory Data Analysis (EDA) │
                         │  - Histogram of attendance       │
                         │  - mean–variance check           │
                         │  → Identify skewness & overdispersion
                         └──────────────────────────────────┘
                                         │
                                         ▼
                   ┌───────────────────────────────────────────────┐
                   │ Univariate Analysis                           │
                   │ - Kruskal–Wallis tests for each predictor     │
                   │ - Compute η² effect sizes                     │
                   │ → Assess which predictors show meaningful     │
                   │   variation in attendance                     │
                   └───────────────────────────────────────────────┘
                                         │
                                         ▼
             ┌──────────────────────────────────────────────────────────┐
             │ Model Building: Cross-Validated Variable Selection       │
             │ - Define Simple, Medium, Full predictor sets             │
             │ - Monte Carlo CV with RMSE as performance metric         │
             │ → Select predictor set with best out-of-sample RMSE      │
             └──────────────────────────────────────────────────────────┘
                                         │
                                         ▼
             ┌──────────────────────────────────────────────────────────┐
             │ Final Model Fitting                                      │
             │ - Fit Negative Binomial regression using selected vars   │
             │ - Extract IRRs and confidence intervals                  │
             │ → Interpret effect sizes and direction of associations   │
             └──────────────────────────────────────────────────────────┘
                                         │
                                         ▼
                   ┌───────────────────────────────────────────────┐
                   │ Final Inference & Interpretation              │
                   │ - Discuss strongest predictors                │
                   │ - Compare event characteristics & attendance  │
                   │ - Guide practical recommendations             │
                   └───────────────────────────────────────────────┘


### Exploratory distribution plots

Before conducting formal statistical analyses, we examined the distribution of the outcome variable, attendance, to assess its shape and variability. Understanding the distribution is essential for determining whether parametric assumptions are met and for selecting an appropriate modeling framework.    
```{r message = FALSE, warning = FALSE}
 a <- ggplot(parkevent, aes(x = attendance)) +
  geom_histogram(bins = 40, fill = "steelblue", color = "white") +
  labs(title = "Attendance Distribution (Count)",
       x = "Attendance", y = "Count") +
  theme_minimal()

b <- ggplot(parkevent, aes(x = attendance)) +
  geom_histogram(bins = 40, fill = "tomato", color = "white") +
  scale_x_log10() +
  labs(title = "Attendance Distribution (Log Scale)",
       x = "Attendance (log10 scale)", y = "Count") +
  theme_minimal()

a+b
```

```{r message = FALSE, warning = FALSE}
mean_var <- parkevent |>
  summarise(mean_att = mean(attendance), var_att = var(attendance)) |>
  rename(
    `Mean Attendance`   = mean_att,
    `Variance of Attendance` = var_att)

knitr::kable(mean_var, digits = 2, caption = "Mean and Variance of Event Attendance")
```

Exploratory plots revealed that attendance is highly right-skewed with a long tail, and the variance greatly exceeds the mean, indicating overdispersion. These characteristics justify the use of non-parametric tests in the univariate stage and a Negative Binomial model for the final multivariable analysis.    


### Univariate Analysis

We first examined whether attendance differed across levels of each categorical predictor (season, time of day, borough, event type, location type, and audience-related indicators) using the Kruskal–Wallis test, a non-parametric method appropriate for skewed count outcomes. For each variable, we also computed an η² effect size to quantify the magnitude of group differences. These results provide an initial assessment of which predictors meaningfully explain variation in attendance and should be considered in subsequent multivariable modeling.    

```{r message = FALSE, warning = FALSE}
predictors <- c("season", "time_period", "borough",
                "event_type", "location_type",
                "kids_friendly", "senior_friendly", "adults_only")

#Function to compute eta-squared for KW
eta_kw <- function(x, g){
  kw <- kruskal.test(x ~ g)
  H  <- kw$statistic
  k  <- length(unique(g))
  n  <- length(x)
  eta2 <- as.numeric((H - k + 1) / (n - k))
  return(eta2)
}

# Run Kruskal–Wallis tests for all predictors
kw_results <- map_df(predictors, ~ {
  form <- as.formula(paste("attendance ~", .x))
  
  kt  <- broom::tidy(kruskal.test(form, data = parkevent))
  eta2 <- eta_kw(parkevent$attendance, parkevent[[.x]])
  
  kt |> 
    mutate(variable = .x,
           eta2 = eta2)
})

# Classify effect sizes ----
kw_results <- kw_results |> 
  mutate(effect_strength = case_when(
    eta2 >= 0.14 ~ "large",
    eta2 >= 0.06 ~ "medium",
    eta2 >= 0.01 ~ "small",
    TRUE ~ "very small"
  ))

kw_results |>
  dplyr::select (variable, p.value, effect_strength) |>
  dplyr::mutate(
    p.value = format(p.value, scientific = TRUE, digits = 3)) |>
  knitr::kable(caption = "Kruskal–Wallis Test Results: P-values and Effect Size Classification")
```

Across all predictors, the Kruskal–Wallis tests indicated statistically significant differences in attendance (p < 0.05), with effect sizes ranging from very small to medium. Variables with medium η² values (event type and location type) show stronger associations with attendance and were prioritized for inclusion in the multivariable model.    

To evaluate their combined predictive value and adjust for potential confounding, we proceeded to build multivariable models.    

### Multivariable Model: Negative Binomial Regression

To identify the predictors that best explain variation in attendance, we compared several candidate models using cross-validated RMSE, an unbiased measure of out-of-sample predictive performance. We used log-linear models for this stage because they are computationally stable and well-suited for repeated Monte Carlo cross-validation. Based on the RMSE comparison, we selected the most predictive set of variables and then refit the final model using Negative Binomial regression, which is appropriate for inference with overdispersed count outcomes such as attendance.    

```{r message = FALSE, warning = FALSE}
#Define candidate models
form_simple <- log(attendance + 1) ~ event_type + location_type

form_medium <- log(attendance + 1) ~ season + time_period + borough +
  event_type + location_type

form_full <- log(attendance + 1) ~ season + time_period + borough +
  event_type + location_type + kids_friendly + senior_friendly + adults_only

#cross-validated RMSE
cv_rmse <- function(formula, data, n_splits = 50, test_prop = 0.1) {
  set.seed(123)
  
cv <- crossv_mc(data, n_splits, test = test_prop)
  
cv <- cv %>%
    mutate(
      model = map(train, ~ lm(formula, data = .x)),
      rmse  = map2_dbl(model, test, ~ rmse(.x, .y))
    )
  
mean(cv$rmse)
}

rmse_simple <- cv_rmse(form_simple, parkevent, n_splits = 50, test_prop = 0.1)
rmse_medium <- cv_rmse(form_medium, parkevent, n_splits = 50, test_prop = 0.1)
rmse_full   <- cv_rmse(form_full,   parkevent, n_splits = 50, test_prop = 0.1)

cv_results <- tibble(
  model     = c("Simple", "Medium", "Full"),
  mean_RMSE = c(rmse_simple, rmse_medium, rmse_full)
)

cv_results |> knitr::kable(digits = 2)
```

Cross-validated RMSE values were similar across the three candidate models, with the Full model achieving the lowest prediction error (RMSE = 1.4263). Although the difference is modest, the Full model provided the best out-of-sample predictive performance and was therefore selected for the final analysis.    

Using the selected predictor set, we fit our final model with a Negative Binomial regression:    

```{r message = FALSE, warning = FALSE}
model_nb <- glm.nb(
  attendance ~ season + time_period + borough +
    event_type + location_type + kids_friendly + senior_friendly + adults_only,
  data = parkevent
)

irr_table <- tidy(model_nb, conf.int = TRUE, exponentiate = TRUE)
irr_table |>  
  mutate(across(where(is.numeric), ~ round(.x, 3))) %>%
  knitr::kable(caption = "Negative Binomial Model Results")

```

```{r echo=FALSE, message=FALSE}
fmt <- function(x) format(round(x, 2), nsmall = 2)

get_ci <- function(df, term_name) {
  vals <- df |> dplyr::filter(term == term_name)
  list(
    irr  = fmt(vals$estimate),
    low  = fmt(vals$conf.low),
    high = fmt(vals$conf.high)
  )
}

terms <- irr_table$term

IRR_vals <- lapply(terms, function(t) get_ci(irr_table, t))
names(IRR_vals) <- terms
```

In this model, attendance is modeled as a function of season, time of day, borough, event type, location type, and audience indicators. We exponentiate the coefficients to obtain incidence rate ratios (IRRs) and 95% confidence intervals, which quantify the multiplicative change in expected attendance associated with each predictor while holding the others constant.    

The Negative Binomial model shows that several event characteristics are strongly associated with attendance.     
Compared with spring events, winter events have significantly lower expected attendance (IRR = `r IRR_vals$seasonWinter$irr`, 95% CI: `r IRR_vals$seasonWinter$low`–`r IRR_vals$seasonWinter$high`), while summer and fall do not differ significantly from spring. 

Afternoon and night events attract more participants than morning events (Afternoon: IRR = `r IRR_vals$time_periodAfternoon$irr`, 95% CI: `r IRR_vals$time_periodAfternoon$low`–`r IRR_vals$time_periodAfternoon$high`; Night: IRR = `r IRR_vals$time_periodNight$irr`, 95% CI: `r IRR_vals$time_periodNight$low`–`r IRR_vals$time_periodNight$high`). Relative to Bronx, events in Manhattan, Queens, and Staten Island show higher attendance (IRRs ≈ `r IRR_vals$boroughQueens$irr`-`r IRR_vals$boroughManhattan$irr`), with Manhattan having the largest effect. 

Community-based events have higher attendance than Agency Produced events (IRR = `r IRR_vals[["event_typeCommunity Based Event"]]$irr`, 95% CI: `r IRR_vals[["event_typeCommunity Based Event"]]$low`–`r IRR_vals[["event_typeCommunity Based Event"]]$high`), and events held in schools and parks are particularly well-attended (School: IRR = `r IRR_vals$location_typeSchool$irr`, 95% CI: `r IRR_vals$location_typeSchool$low`–`r IRR_vals$location_typeSchool$high`; Park: IRR = `r IRR_vals$location_typePark$irr`, 95% CI: `r IRR_vals$location_typePark$low`–`r IRR_vals$location_typePark$high`).  

For the audience, the kids-friendly and senior-friendly indicators are not individually significant after adjustment for other covariates.     
    
```{r}
irr_table2 <- irr_table %>%
  filter(term != "(Intercept)") %>%
  mutate(
    significant = ifelse(conf.low > 1 | conf.high < 1, "Significant", "Not Significant")
  )

ggplot(irr_table2, aes(x = reorder(term, estimate), y = estimate,
                       color = significant)) +
  geom_point(size = 3) +
   geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  scale_color_manual(values = c("Significant" = "red", 
                                "Not Significant" = "steelblue")) +
  coord_flip() +
  labs(
    title = "Incidence Rate Ratios (IRRs) with 95% Confidence Intervals",
    x = "Predictor",
    y = "IRR",
    color = ""
  ) +
  theme_minimal(base_size = 13)
```
     
A forest plot of IRRs was created to visually summarize the estimated effects and identify predictors with statistically significant associations with attendance.  